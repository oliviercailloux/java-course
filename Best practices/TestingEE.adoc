= Testing in Java EE

== JUnit
A simple and reasonable approach to unit testing a Java EE project is to JUnit-test components without using container services. The drawback is that it does not allow coarse-grained functional tests.

One problem you might encounter, however, is an `ExceptionInInitializerError` when you initialize a Servlet class in a Java SE environment, caused by a `MissingResourceException: Can't find bundle for base name javax.servlet.LocalStrings`. This is because the `javax:javaee-api:8.0` dependency contains all classes from the Servlet 4.0.0 specification (as required by the Java EE 8 https://www.oracle.com/java/technologies/java-ee-glance.html#javaee8[specification]), except for the `javax.servlet.LocalStrings` bundle (which seems like a bug to me). To work around this, add the `javax.servlet:javax.servlet-api:4.0.0` dependency (with scope `provided`) to your POM. Note that you have to use version 4.0.0 and not a more recent one (https://search.maven.org/search?q=g:javax.servlet%20AND%20a:javax.servlet-api&core=gav[4.0.1] is available on Maven Central) to make sure it matches the version provided by your (Java EE 8 compliant) application server at runtime. See this https://github.com/oliviercailloux/samples/blob/master/JavaEE-Inject-Servlets-Conversation/pom.xml[sample] POM. [https://stackoverflow.com/questions/31561603/java-util-missingresourceexception-cant-find-bundle-for-base-name-javax-servle[Thanks]]

[[JUnit-CDI]]
== JUnit and CDI
Unit testing objects that heavily rely on CDI (or other container services) is not recommended: if you really wish to test properly in isolation, you need to mock up injected services, which is a pain (see The https://antoniogoncalves.org/2012/11/27/launching-the-nomock-movement/[NoMock] Movement and this https://antoniogoncalves.org/2012/01/16/wytiwyr-what-you-test-is-what-you-run/[opinion] for further details).

== Arquillian
The most classical and probably simplest solution is to use Arquillian, as illustrated https://github.com/oliviercailloux/sample-jax-rs[here].

== Live server
See also: testing a https://antoniogoncalves.org/2012/10/24/no-you-dont-need-to-mock-your-soap-web-service-to-test-it/[SOAP] / https://antoniogoncalves.org/2012/12/19/test-your-jax-rs-2-0-web-service-uris-without-mocks/[JAX-RS] WS in a live HTTP Server.

[[Weld-SE]]
== Weld SE
Relaxing the isolation requirement, a possible approach involves using a standalone Weld instance (using Weld SE) responsible for injecting the CDI managed beans. My https://github.com/oliviercailloux/samples/tree/master/JavaEE-JPA-Inject-Servlets-JUnit[JavaEE-JPA-Inject-Servlets-JUnit] sample illustrates it.

Observing how difficult and not clean it is, however, *I’d rather recommend using an alternative* (Arquillian comes to mind, see the opinion above).

* In Weld SE, the file `beans.xml` is required even for `annotated` bean discovery mode in implicit bean archives. “In general, an implicit bean archive does not have to contain a beans.xml descriptor. However, such a bean archive is not supported by Weld SE, i.e. it’s excluded from discovery.” — Weld doc https://docs.jboss.org/weld/reference/latest/en-US/html/environments.html#_implicit_bean_archive_support_2[Implicit Bean Archive Support in Java SE] (compare normal https://docs.jboss.org/weld/reference/latest/en-US/html/ee.html#packaging-and-deployment[Packaging and deployment]).
* Weld SE has apparently a https://stackoverflow.com/a/30325614/859604[bug] that makes it fail to discover beans that are in different subtrees than the `beans.xml` file. Following best practices, the test files (including the `beans.xml` file, required only for Weld SE) should be in the `/src/test/` subfolders. But this would trigger the bug, Weld SE throwing exceptions of the kind `org.jboss.weld.exceptions.UnsatisfiedResolutionException: WELD-001334: Unsatisfied dependencies for type (…) with qualifiers (…)`. In `weld-se-wrong-annotated-build-discovery-mode`, I worked around the bug by moving a https://github.com/oliviercailloux/samples/blob/weld-se-wrong-annotated-build-discovery-mode/JavaEE-JPA-Inject-Servlets-JUnit/src/main/java/io/github/oliviercailloux/javaee_jpa_inject_servlets_junit/utils/ManagedReqScopeTester.java[class] and the https://github.com/oliviercailloux/samples/blob/weld-se-wrong-annotated-build-discovery-mode/JavaEE-JPA-Inject-Servlets-JUnit/src/main/resources/META-INF/beans.xml[`beans.xml`] file in `/src/main/`. This has another problem however: Weld SE is now a compile-time dependency (and can’t be restricted to `<scope>test</scope>`), thus, should be upgraded to a compilation-scoped dependency in the https://github.com/oliviercailloux/samples/blob/weld-se-wrong-annotated-build-discovery-mode/JavaEE-JPA-Inject-Servlets-JUnit/pom.xml[`pom`]. That would be asking for trouble when deploying the app.
* Thus I gave up on `annotated` bean discovery mode, removed the `beans.xml` file, and used dynamic https://docs.jboss.org/weld/reference/latest/en-US/html/environments.html#_bootstrapping_cdi_se[explicit] bean declaration when https://github.com/oliviercailloux/samples/blob/weld-se-wrong-annotated-build-discovery-mode/JavaEE-JPA-Inject-Servlets-JUnit/src/test/java/io/github/oliviercailloux/javaee_jpa_inject_servlets_junit/utils/TestReqScopeInjection.java[instantiating] the container.
* If you really want to go for testing using Weld SE, there was perhaps a way to clean up the code a bit compared to this sample, at \https://developer.jboss.org/wiki/CreatingUnitTestsWithWeldAndJunit4, but this link is now broken, and I don’t believe this would be enough to really bring a satisfactory solution to the whole testing requirements, thus I stopped investigating. Also, other (better?) ways to manage the contexts exist, see https://docs.jboss.org/weld/reference/latest/en-US/html/contexts.html#_managing_the_built_in_contexts[Managing the built in contexts] in Weld doc; https://stackoverflow.com/questions/26631093/no-active-contexts-for-scope-type-javax-enterprise-context-requestscoped-when-in[SO].


